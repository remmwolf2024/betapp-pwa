<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Panel</title>
  <style>
    body { font-family: system-ui, -apple-system, Arial; padding: 24px; max-width: 980px; margin: 0 auto; }
    h1 { font-size: 44px; margin: 10px 0 6px; }
    .muted { color:#666; margin-bottom: 18px; }
    .card { border: 1px solid #ddd; border-radius: 14px; padding: 18px; margin: 16px 0; }
    label { display:block; font-weight: 700; margin-top: 12px; }
    input, textarea, button { width: 100%; padding: 14px; font-size: 16px; margin-top: 8px; }
    textarea { min-height: 110px; }
    .row { display:flex; gap: 12px; align-items:flex-end; }
    .row > div { flex:1; }
    .btn { cursor:pointer; }
    .btnSmall { width:auto; padding: 10px 14px; }
    table { width:100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border-top:1px solid #eee; padding: 12px 10px; text-align:left; }
    th { background:#fafafa; }
    .pill { display:inline-block; padding: 4px 10px; border-radius: 999px; border:1px solid #ddd; font-size: 13px; }
    .green { border-color:#0a7; color:#0a7; font-weight:700; }
    .red { border-color:#c00; color:#c00; font-weight:700; }
    pre { background:#f7f7f7; border-radius: 10px; padding: 12px; overflow:auto; }
    .hint { font-size: 13px; color:#666; margin-top: 6px; }
  </style>
</head>
<body>
  <h1>Admin Panel</h1>
  <div class="muted">Giriş: kullanıcı adı + şifre (Basic Auth). Başlık max 40, mesaj max 120.</div>

  <div class="card">
    <h2>Giriş</h2>
    <div class="row">
      <div>
        <label>Kullanıcı adı</label>
        <input id="u" placeholder="admin">
      </div>
      <div>
        <label>Şifre</label>
        <input id="p" type="password" placeholder="••••••••">
      </div>
      <div style="flex:0 0 160px;">
        <button class="btn" id="loginBtn">Giriş Yap</button>
      </div>
    </div>
    <div id="loginInfo" class="hint"></div>
  </div>

  <div class="card">
    <h2>Bildirim Gönder</h2>

    <label>Başlık (max 40)</label>
    <input id="title" maxlength="40" placeholder="Freespin!" />

    <label>Mesaj (max 120)</label>
    <textarea id="body" maxlength="120" placeholder="Bugüne özel ..."></textarea>

    <button class="btn" id="sendBtn">Gönder</button>
    <pre id="sendOut"></pre>
  </div>

  <div class="card">
    <h2>Kullanıcılar</h2>

    <div class="row">
      <div>
        <label>Username ara (tüm kullanıcılar)</label>
        <input id="search" placeholder="örn: test, ali, anil123">
        <div class="hint">Bu arama tüm kayıtları tarar. Sonuçlar en son görülenlere göre sıralanır.</div>
      </div>
      <div style="flex:0 0 160px;">
        <button class="btn btnSmall" id="searchBtn">Ara</button>
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <div style="flex:0 0 220px;">
        <button class="btn" id="listBtn">Kullanıcıları Listele</button>
      </div>
      <div style="flex:0 0 220px;">
        <button class="btn" id="nextBtn">Sonraki Sayfa</button>
      </div>
      <div style="flex:1; display:flex; align-items:center; justify-content:flex-end;">
        <span id="pageInfo" class="hint"></span>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Kullanıcı</th>
          <th>Platform</th>
          <th>Tarayıcı</th>
          <th>Installed</th>
          <th>Push</th>
          <th>Son görülme</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

<script>
  // Burayı kendi WORKER domaininle eşleştir
  const WORKER_BASE = "https://betapp-pwa.remmwolf2024.workers.dev";

  const $ = (id) => document.getElementById(id);

  function basicAuthHeader(u, p){
    return "Basic " + btoa(`${u}:${p}`);
  }

  function fmtTs(ts){
    if(!ts) return "-";
    const d = new Date(ts);
    return d.toLocaleString("tr-TR");
  }

  function pill(text, ok){
    return `<span class="pill ${ok ? 'green':'red'}">${text}</span>`;
  }

  function renderUsers(users){
    const tb = $("tbody");
    tb.innerHTML = "";
    for(const u of users){
      const pushOk = !!u.subscribed;
      const instOk = !!u.installed;

      tb.insertAdjacentHTML("beforeend", `
        <tr>
          <td><b>${(u.username||"-")}</b></td>
          <td><span class="pill">${u.platform||"-"}</span></td>
          <td><span class="pill">${u.browser||"-"}</span></td>
          <td>${pill(instOk ? "Evet" : "Hayır", instOk)}</td>
          <td>${pill(pushOk ? "Açık" : "Kapalı", pushOk)}</td>
          <td>${fmtTs(u.last_seen)}</td>
        </tr>
      `);
    }
  }

  function getCreds(){
    return {
      u: $("u").value.trim(),
      p: $("p").value
    };
  }

  function saveCreds(){
    localStorage.setItem("admin_u", $("u").value.trim());
    localStorage.setItem("admin_p", $("p").value);
  }

  function loadCreds(){
    const u = localStorage.getItem("admin_u") || "";
    const p = localStorage.getItem("admin_p") || "";
    $("u").value = u;
    $("p").value = p;
    if(u && p) $("loginInfo").textContent = "Otomatik giriş hazır (kayıtlı).";
  }

  async function adminFetch(path, opts={}){
    const {u,p} = getCreds();
    const headers = new Headers(opts.headers || {});
    headers.set("Authorization", basicAuthHeader(u,p));
    return fetch(WORKER_BASE + path, { ...opts, headers });
  }

  let cursor = null;
  let mode = "list"; // list | search

  $("loginBtn").onclick = async () => {
    saveCreds();
    // test auth with small call
    const r = await adminFetch("/users?limit=1");
    if(r.status === 401){
      $("loginInfo").textContent = "Giriş hatalı.";
      $("loginInfo").style.color = "#c00";
    } else {
      $("loginInfo").textContent = "Giriş başarılı.";
      $("loginInfo").style.color = "#0a7";
    }
  };

  $("sendBtn").onclick = async () => {
    saveCreds();
    const title = $("title").value.slice(0,40);
    const body = $("body").value.slice(0,120);

    const r = await adminFetch("/send", {
      method:"POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ title, body })
    });

    const txt = await r.text();
    $("sendOut").textContent = txt;
  };

  $("listBtn").onclick = async () => {
    saveCreds();
    mode = "list";
    cursor = null;

    const r = await adminFetch("/users?limit=50");
    if(r.status === 401){ $("pageInfo").textContent = "Giriş gerekli."; return; }

    const data = await r.json();
    renderUsers(data.users || []);
    cursor = data.cursor || null;
    $("pageInfo").textContent = cursor ? "Sayfa 1" : "Tek sayfa";
  };

  $("nextBtn").onclick = async () => {
    saveCreds();
    if(mode !== "list"){
      $("pageInfo").textContent = "Arama modunda sayfalama yok. Tekrar listelemek için 'Kullanıcıları Listele' tıkla.";
      return;
    }
    if(!cursor){
      $("pageInfo").textContent = "Son sayfa.";
      return;
    }

    const r = await adminFetch("/users?limit=50&cursor=" + encodeURIComponent(cursor));
    if(r.status === 401){ $("pageInfo").textContent = "Giriş gerekli."; return; }

    const data = await r.json();
    renderUsers(data.users || []);
    cursor = data.cursor || null;
    $("pageInfo").textContent = cursor ? "Sonraki sayfa yüklendi" : "Son sayfa";
  };

  $("searchBtn").onclick = async () => {
    saveCreds();
    mode = "search";
    cursor = null;

    const q = $("search").value.trim();
    if(!q){ $("pageInfo").textContent = "Arama için username yaz."; return; }

    const r = await adminFetch("/search?username=" + encodeURIComponent(q) + "&limit=200");
    if(r.status === 401){ $("pageInfo").textContent = "Giriş gerekli."; return; }

    const data = await r.json();
    renderUsers(data.users || []);
    $("pageInfo").textContent = `Arama sonucu: ${(data.users||[]).length} kayıt`;
  };

  loadCreds();
</script>
</body>
</html>
